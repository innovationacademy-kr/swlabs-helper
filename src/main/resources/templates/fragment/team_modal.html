<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
</head>
<body>
<!-- Modal -->
<div th:fragment="modal" class="modal fade" id="team_modal" tabindex="-1"
     aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">시간 설정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h2> 시간 설정 </h2>
                <form class="m-3 needs-validation" method="post" id="create_team_form">
                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="select_project" class="form-label">프로젝트 명칭</label>
                                <select class="form-select" id="select_project" required>
                                    <option selected disabled="disabled" value="">프로젝트 선택하기</option>
                                    <option th:each="proj : ${projects}"
                                            th:value="${proj.id}"
                                            th:utext="${proj.name}"></option>
                                </select>
                            </div>
                        </div>

                        <div class="col-6">
                            <div class="mb-3">
                                <label for="select_location" class="form-label">장소</label>
                                <select class="form-select" id="select_location" required>
                                    <option selected value="">장소 선택하기</option>
                                    <option th:each="loc : ${locations}"
                                            th:value="${loc.id}"
                                            th:utext="${loc.name}"></option>
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="input_max_member_count" class="form-label">참여 인원</label>
                                <input class="form-control" id="input_max_member_count" th:type="number"
                                       th:min="2" required>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="input_datepicker" class="form-label">날짜</label>
                                <input id="input_datepicker" class="form-control" required autocomplete="off"/>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="demo__body py-3">
                            <input id="input_time_rangeslider" type="text">
                        </div>
                    </div>
                </form>
                <div class="members_in_team">
                    <h5>현재 멘티 목록</h5>
                    <ul class="member_list list-group">
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-primary" id="team_modal_btn_submit" onclick="submit_team()">생성
                </button>
            </div>
        </div>
    </div>
</div>
</body>
<div th:fragment="script">
    <!--slider plugin -->
    <!--link : https://github.com/IonDen/ion.rangeSlider-->
    <!--Plugin JavaScript file-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>
    <!--datepicker plugin-->
    <script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
    <!--Moment plugin-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

    <script>
        var lang = "ko-KR";
        var locations = undefined;

        var s_year = 2021;
        var s_month = 6;
        var s_date = 10;
        var ajax_req_info;

        function getLocations() {
            let data;
            $.ajax({
                    type: "GET",
                    url: "./api/v1/team/locations",
                    data: null,
                    async: false,
                    dataType: "JSON",
                    contentType: 'application/json',
                    success: (rst) => data = rst.data,
                    error: (request, status, error) => {
                        alert("서버에서 데이터 읽기를 실패했습니다.\n" + request.status + "\nmessage: "
                            + request.responseText + "\nerror:" + error);
                    }
                }
            )
            return data;
        }

        function timeToTS(m) {
            return m.valueOf();
        }

        function tsToTime(ts) {
            var m = moment(ts);

            m.toISOString();
            if (m.hour() == 0 && m.date() > s_date)
                return "24:00";
            else
                return m.format("HH:mm");
        }

        $("#input_time_rangeslider").ionRangeSlider({
            skin: "round",
            type: "double",
            grid: true,
            min: timeToTS(moment(new Date(s_year, s_month, s_date, 0, 0, 1))),
            max: timeToTS(moment(new Date(s_year, s_month, s_date + 1, 0, 0, 0))),
            from: timeToTS(moment(new Date(s_year, s_month, s_date, 6, 0, 0))),
            to: timeToTS(moment(new Date(s_year, s_month, s_date, 18, 0, 0))),
            step: 900000,
            prettify: tsToTime
        }).addClass("irs-hidden-input");

        const time_rangeslider = $("#input_time_rangeslider").data("ionRangeSlider");


        function set_team_modal_datepicker() {
            $('#input_datepicker').datepicker({
                uiLibrary: 'bootstrap4',
                format: 'yyyy-mm-dd',
                minDate: function () {
                    const date = new Date();
                    return new Date(date.getFullYear(), date.getMonth(), date.getDate())
                },
                footer: true
            });
            // datepicker의 bootstrap4 의존성으로 인한 ui 수정
            $('#input_datepicker').next().attr('role', 'icon');
        }

        function set_team_modal_info(team) {
            if (locations == undefined)
                locations = getLocations();

            const s_moment = moment(team.startTime);
            s_year = s_moment.year();
            s_month = s_moment.month();
            s_date = s_moment.date();
            time_rangeslider.update({
                min: timeToTS(moment(new Date(team.startTime))),
                max: timeToTS(moment(new Date(team.endTime))),
                from: timeToTS(moment(new Date(team.startTime))),
                to: timeToTS(moment(new Date(team.endTime)))
            })

            var loc_id = 0;
            locations.some(element => {
                if (element.code == team.location) {
                    loc_id = element.id
                    return true;
                }
            });

            const selected_opt_project = $("#select_project option[value='" + team.project.id + "']");
            selected_opt_project.attr("selected", "selected");

            const selected_opt_location = $("#select_location option[value='" + loc_id + "']");
            selected_opt_location.attr("selected", "selected");

            const $memberList = $('.member_list');
            $memberList.empty();
            team.members.forEach((member) => {
                if (member.memberRole == "멘토") {
                    $memberList.append('<li class="list-group-item">' + member.nickname + '' +
                        ' <span class="rounded-pill bg-danger text-light p-1" style="font-size: 0.85em">멘토</span> </li>');
                } else {
                    $memberList.append('<li class="list-group-item">' + member.nickname + '</li>');
                }
            })

            if (loc_id != 0) { // Enum TeamLocation NONE id
                $('#select_location').attr('disabled', 'true');
            }

            $('#input_datepicker').val(moment(team.startTime).format('YYYY-MM-DD'));
            $('#input_max_member_count').val(team.maxMemberCount);
            $('#create_team_form').attr('team_id', team.teamId);
        }

        var memberRole;

        function set_team_modal_mode(mode) {
            if (mode == "CREATE_TEAM") {
                $('#select_project').attr("disabled", "true");
                $('#input_datepicker').attr('readonly', 'true');
                $('#input_max_member_count').attr('readonly', 'true');
            } else if (mode == "READONLY_TEAM") {
                $('#select_project').attr("disabled", "true");
                $('#select_location').attr("disabled", "true");
                $('#input_datepicker').attr('readonly', 'true');
                $('#input_max_member_count').attr('readonly', 'true');
                $('#team_modal_btn_submit').attr('disabled', 'true');
                time_rangeslider.update({
                    disable: true
                });
            } else if (mode == "CREATE_TEAMWISH_MENTEE") {
                set_team_modal_datepicker();
                memberRole = "MENTEE";
                return;
            } else if (mode == "CREATE_TEAMWISH_MENTOR") {
                set_team_modal_datepicker();
                memberRole = "MENTOR"
                return;
            }
        }

        function team_modal_update(data) {
            if (data == undefined) return;
            if (data.mode != undefined) set_team_modal_mode(data.mode)
            if (data.team != undefined) set_team_modal_info(data.team)
            if (data.ajax_req_info != undefined) ajax_req_info = data.ajax_req_info
        }

        function team_modal_show() {
            var detail_modal = new bootstrap.Modal(document.getElementById('team_modal'))
            detail_modal.show();
        }


        /* ajax action func*/
        function submit_team() {
            const form = document.getElementById('create_team_form');
            if (form.checkValidity() == false) {
                form.classList.add("was-validated");
                return;
            }
            const projectId = $('#select_project option:selected').attr("value");
            const location = $('#select_location option:selected').attr("value");
            const maxMemberCount = $('#input_max_member_count').val();
            const date = moment($('#input_datepicker').val());
            var [start, end] = $('#input_time_rangeslider').val().split(';')
            const offset_date = new Date(s_year, s_month, s_date, 0, 0, 0).valueOf();
            start = parseInt(start) - offset_date;
            end = parseInt(end) - offset_date;
            const start_date = date.valueOf() + start;
            const end_date = date.valueOf() + end;

            $.ajax({
                    type: ajax_req_info.type,
                    url: ajax_req_info.url,
                    data: JSON.stringify({
                        startTime: moment(start_date).format("YYYY-MM-DDTHH:mm"),
                        endTime: moment(end_date).format("YYYY-MM-DDTHH:mm"),
                        location: location,
                        maxMemberCount: parseInt(maxMemberCount),
                        projectId: projectId,
                        memberRole: memberRole
                    }),
                    dataType: "JSON",
                    contentType: 'application/json',
                    success: (data) => {
                        if (data.statusCode != 200) {
                            alert("생성에 실패했습니다.\n" + data.message);
                        } else {
                            alert("등록되었습니다.")
                            ajax_req_info.success();
                        }
                    },
                    error: (request, status, error) => {
                        alert("등록을 실패했습니다.\n" + request.status + "\nmessage: "
                            + request.responseText + "\nerror:" + error);
                    }
                }
            )
        }
    </script>
</div>
</html>