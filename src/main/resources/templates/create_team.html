<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="layout/default_layout.html" th:with="currentPage='create_team'">
<head>
  <title>Create team</title>
  <!-- Plugin CSS file with desired ski n-->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/css/ion.rangeSlider.min.css"/>
</head>

<div layout:fragment="custom-content">
  <!-- Modal -->
  <div class="modal fade" id="team_detail_modal" tabindex="-1" aria-labelledby="exampleModalLabel"
       aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">시간 설정</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h2> 시간 설정 </h2>
          <form class="m-3 needs-validation" method="post" id="create_team_form">
            <div class="row">
              <div class="col-6">
                <div class="mb-3">
                  <label for="select_project" class="form-label">프로젝트 명칭</label>
                  <select class="form-select" id="select_project" required disabled>
                    <option selected disabled="disabled" value="">프로젝트 선택하기</option>
                    <option th:each="proj : ${projects}"
                            th:value="${proj.id}"
                            th:utext="${proj.name}"></option>
                  </select>
                </div>
              </div>

              <div class="col-6">
                <div class="mb-3">
                  <label for="select_location" class="form-label">장소</label>
                  <select class="form-select" id="select_location" required disabled>
                    <option selected value="">장소 선택하기</option>
                    <option th:each="loc : ${locations}"
                            th:value="${loc.id}"
                            th:utext="${loc.name}"></option>
                    </option>
                  </select>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-6">
                <div class="mb-3">
                  <label for="input_max_member_count" class="form-label">참여 인원</label>
                  <input class="form-control" id="input_max_member_count" th:type="number"
                         th:min="2"
                         required readonly>
                </div>
              </div>
              <div class="col-6">
                <div class="mb-3">
                  <label for="input_datepicker" class="form-label">날짜</label>
                  <input id="input_datepicker" class="form-control" required readonly/>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="demo__body py-3">
                <input id="input_time_range_slider" type="text">
              </div>
            </div>
          </form>
          <div class="members_in_team">
            <h5>현재 멘티 목록</h5>
            <ul class="member_list list-group">
            </ul>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="button" class="btn btn-primary" onclick="submit_team()">생성</button>
        </div>
      </div>
    </div>
  </div>

  <h2>멘티 목록</h2>
  <div class="list-container">
    <table class="table">
      <thead>
      <tr>
        <th scope="col">#</th>
        <th scope="col">프로젝트 명칭</th>
        <th scope="col">장소</th>
        <th scope="col">희망 인원</th>
        <th scope="col">희망 일자</th>
        <th scope="col">희망 시간</th>
        <th scope="col">개설자</th>
        <th scope="col">작업</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="team : ${teams}">
        <th scope="row" th:text="${team.teamId}">팀 아이디</th>
        <td th:text="${team.project.getName()}">프로젝트 명칭</td>
        <td th:text="${team.location.getName()}"></td>
        <td th:text="${team.maxMemberCount} == 0 ? '상관 없음' : ${team.maxMemberCount}">3</td>
        <td>
          <div th:if="${team.startTime} AND ${team.endTime}">
            <span th:text="${#temporals.format(team.startTime, 'MM/dd')}">날짜</span>
          </div>
          <div th:if="${team.startTime} == null OR ${team.endTime} == null" th:text="상관없음"></div>
        </td>
        <td>
          <div th:if="${team.startTime} AND ${team.endTime}">
            <span th:text="${#temporals.format(team.startTime, 'HH:mm')}">시작시간</span>
            ~
            <span th:text="${#temporals.format(team.endTime, 'HH:mm')}">종료시간</span>
          </div>
          <div th:if="${team.startTime} == null OR ${team.endTime} == null" th:text="상관없음"></div>
        </td>
        <td th:text="${team.getNicknameByMentee()}"></td>
        <td>
          <button type="button" class="btn btn-primary"
                  th:onclick="onclick_detail([[${team}]], [[${team.location.getId()}]])">
            세부사항 확인
          </button>
        </td>
      </tr>
      </tbody>
    </table>

    <nav th:with="
                  maxPage=${5},
                  start=${(teams.number/maxPage)*maxPage + 1},
                  end=(${(teams.totalPages == 0) ? 1 : (start + (maxPage - 1) < teams.totalPages ? start + (maxPage - 1) : teams.totalPages)})"
         aria-label="Page navigation">
      <ul class=" pagination justify-content-center">
        <li th:if="${start > 1}" class="page-item">
          <a class="page-link" th:href="@{/create_team?(offset=0)}" th:text="'<<'"></a>
        </li>
        <li th:if="${start > 1}" class="page-item">
          <a class="page-link" th:href="@{/create_team?(offset=${start - 2})}" th:text="'<'"></a>
        </li>
        <li class="page-item"
            th:each="offset: ${#numbers.sequence(start, end)}"
            th:classappend="${offset == teams.number + 1} ? 'active'">
          <a class="page-link" th:href="@{/create_team?(offset=${offset - 1})}"
             th:text="${offset}"></a>
        </li>
        <li th:if="${end < teams.totalPages}" class="page-item">
          <a class="page-link" th:href="@{/create_team?(offset=${start + maxPage - 1})}"
             th:text="'>'"></a>
        </li>
        <li th:if="${end < teams.totalPages}" class="page-item">
          <a class="page-link" th:href="@{/create_team?(offset=${teams.totalPages - 1})}"
             th:text="'>>'"></a>
        </li>
      </ul>
    </nav>
  </div>
</div>

<div layout:fragment="custom-footer">
  <!--slider plugin -->
  <!--link : https://github.com/IonDen/ion.rangeSlider-->
  <!--jQuery-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--Plugin JavaScript file-->
  <script
      src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>
  <!--datepicker plugin-->
  <script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
  <!--Moment plugin-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <script>
    var lang = "ko-KR";
    var year = 2018;
    var locations = "[[${locations}]]"

    function timeToTS(date) {
      return date.valueOf();
    }

    function tsToTime(ts) {
      var d = new Date(ts);

      return d.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', hour12: true});
    }

    function onclick_detail(team, loc_id) {
      var detail_modal = new bootstrap.Modal(document.getElementById('team_detail_modal'))
      detail_modal.show();
      $("#input_time_range_slider").ionRangeSlider({
        skin: "round",
        type: "double",
        grid: true,
        min: timeToTS(new Date(team.startTime)),
        max: timeToTS(new Date(team.endTime)),
        from: timeToTS(new Date(team.startTime)),
        to: timeToTS(new Date(team.endTime)),
        step: 900000,
        prettify: tsToTime
      }).addClass("irs-hidden-input");

      const selected_opt_project = $("#select_project option[value='" + team.project.id + "']");
      selected_opt_project.attr("selected", "selected");

      const selected_opt_location = $("#select_location option[value='" + loc_id + "']");
      selected_opt_location.attr("selected", "selected");

      const $memberList = $('.member_list');
      $memberList.empty();
      team.members.forEach((member) => $memberList.append(
          '<li class="list-group-item">' + member.nickname + '</li>'))

      if (loc_id == 0) { // Enum TeamLocation NONE id
        $('#select_location').removeAttr('disabled');
      }

      $('#input_datepicker').val(moment(team.startTime).format('YYYY-MM-DD'));
      $('#input_max_member_count').val(team.maxMemberCount);
      $('#create_team_form').attr('team_id', team.teamId);
    }

    function submit_team() {
      const form = document.getElementById('create_team_form');
      if (form.checkValidity() == false) {
        form.classList.add("was-validated");
        return;
      }
      const projectId = $('#select_project option:selected').attr("value");
      const location = $('#select_location option:selected').attr("value");
      const maxMemberCount = $('#input_max_member_count').val();
      const date = moment($('#input_datepicker').val());
      const [start, end] = $('#input_time_range_slider').val().split(';')
      const start_date = moment(parseInt(start)).set({
        'year': date.year(),
        'month': date.month(),
        'date': date.date()
      })
      const end_date = moment(parseInt(end)).set({
        'year': date.year(),
        'month': date.month(),
        'date': date.date()
      })

      $.ajax({
            type: "PUT",
            url: "./api/v1/team/" + $('#create_team_form').attr('team_id'),
            data: JSON.stringify({
              startTime: start_date.format("YYYY-MM-DDTHH:mm"),
              endTime: end_date.format("YYYY-MM-DDTHH:mm"),
              location: location,
              maxMemberCount: parseInt(maxMemberCount),
              projectId: projectId
            }),
            dataType: "JSON",
            contentType: 'application/json',
            success: (data) => {
              if (data.statusCode != 200) {
                alert("팀 생성에 실패했습니다.\n" + data.message);
              } else {
                alert("팀이 등록되었습니다.")
                window.location.href = '/';
              }
            },
            error: (request, status, error) => {
              alert("등록을 실패했습니다.\n" + request.status + "\nmessage: "
                  + request.responseText + "\nerror:" + error);
            }
          }
      )
    }
  </script>
</div>
</html>